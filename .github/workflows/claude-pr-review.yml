name: "Priority 1: Claude AI PR Review"

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to review (optional - auto-detected for pull_request events)'
        required: false

# Priority 1: Highest priority workflow - PR-specific concurrency to prevent conflicts
concurrency:
  group: priority-1-claude-review-pr-${{ github.event.pull_request.number || github.event.inputs.pr_number }}
  cancel-in-progress: false  # Don't cancel to ensure review completion

jobs:
  claude-review:
    if: github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    timeout-minutes: ${{ vars.CLAUDE_REVIEW_TIMEOUT || 15 }}

    permissions:
      # Minimum required permissions for Claude AI review workflow
      contents: read          # Required: Read repository content for analysis
      pull-requests: write    # Required: Comment on PRs and approve/request changes
      issues: write           # Required: Create comments on PR discussions
      statuses: write         # Required: Create status checks for approval gate
      checks: write           # Required: Create check runs for workflow status
      actions: read           # Required: Read workflow run information for dependencies
      id-token: write         # Required: OIDC token for secure authentication
      # Security: All other permissions explicitly denied

    steps:
      - name: Debug Workflow Trigger
        run: |
          echo "üîç DEBUG: Priority 1 Claude AI Review triggered successfully!"
          echo "Event: ${{ github.event_name }}"
          echo "Action: ${{ github.event.action }}"
          echo "PR Number: ${{ github.event.pull_request.number }}"
          echo "Repository: ${{ github.repository }}"
          echo "Branch: ${{ github.head_ref }}"
          echo "Commit SHA: ${{ github.sha }}"
          echo "Timestamp: $(date -u)"

      - name: Validate Organization
        run: |
          if [[ "${{ github.repository_owner }}" != "blaze-commerce" ]]; then
            echo "‚ùå This workflow is only for blaze-commerce repositories"
            exit 1
          fi
          echo "‚úÖ Organization validation passed"

      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm install --production

      - name: Determine Repository Type
        id: repo-context
        run: |
          if [[ -f "package.json" && -d "src" ]]; then
            echo "repo_type=nextjs-frontend" >> $GITHUB_OUTPUT
            echo "üéØ Detected: Next.js Frontend Repository"
          elif [[ -f "blaze-wooless.php" || -f "*.php" ]]; then
            echo "repo_type=wordpress-plugin" >> $GITHUB_OUTPUT
            echo "üéØ Detected: WordPress Plugin Repository"
          elif [[ -f "style.css" && -f "functions.php" ]]; then
            echo "repo_type=wordpress-child-theme" >> $GITHUB_OUTPUT
            echo "üéØ Detected: WordPress Child Theme Repository"
          else
            echo "repo_type=general" >> $GITHUB_OUTPUT
            echo "üéØ Detected: General Repository"
          fi

      - name: Prepare BlazeCommerce Context
        id: prepare-context
        uses: actions/github-script@v7
        with:
          script: |
            const repoType = '${{ steps.repo-context.outputs.repo_type }}';

            // Repository-specific prompts for BlazeCommerce standards
            const prompts = {
              'nextjs-frontend': `You are reviewing a Next.js/React frontend for BlazeCommerce e-commerce platform.

                Focus on:
                - React component patterns and hooks usage
                - TypeScript type safety and interface design
                - Performance optimization (Core Web Vitals)
                - SEO best practices and meta tag management
                - E-commerce UX patterns and accessibility
                - State management and data fetching patterns
                - Component reusability and maintainability
                - Error boundaries and loading states
                - Mobile responsiveness and cross-browser compatibility
                - Bundle size optimization and code splitting

                Provide categorized feedback:
                üî¥ REQUIRED - Critical issues that must be fixed
                üü° IMPORTANT - Significant improvements needed
                üîµ SUGGESTIONS - Optional enhancements

                Focus on actionable feedback that helps improve code quality, security, and maintainability.`,

              'wordpress-plugin': `You are reviewing a WordPress plugin for BlazeCommerce e-commerce platform.

                Focus on:
                - WordPress coding standards and best practices
                - Security considerations (sanitization, validation, nonces)
                - Database operations and query optimization
                - Hook usage and action/filter implementation
                - Plugin architecture and modularity
                - Compatibility with different WordPress versions
                - Performance impact on WordPress sites
                - Proper enqueuing of scripts and styles
                - Internationalization and localization
                - Error handling and logging
                - Admin interface and user experience
                - REST API implementation and security
                - WooCommerce integration best practices

                Provide categorized feedback:
                üî¥ REQUIRED - Critical issues that must be fixed
                üü° IMPORTANT - Significant improvements needed
                üîµ SUGGESTIONS - Optional enhancements

                Focus on actionable feedback that helps improve code quality, security, and maintainability.`,

              'wordpress-child-theme': `You are reviewing a WordPress child theme for BlazeCommerce e-commerce platform.

                Focus on:
                - Theme hierarchy and WordPress standards
                - CSS organization and maintainability
                - Responsive design and mobile optimization
                - Cross-browser compatibility
                - Performance optimization (CSS/JS)
                - Accessibility compliance (WCAG guidelines)
                - SEO optimization
                - Theme customization best practices
                - PHP template structure and security
                - Asset optimization and loading

                Provide categorized feedback:
                üî¥ REQUIRED - Critical issues that must be fixed
                üü° IMPORTANT - Significant improvements needed
                üîµ SUGGESTIONS - Optional enhancements

                Focus on actionable feedback that helps improve code quality, security, and maintainability.`,

              'general': `You are reviewing code for BlazeCommerce platform.

                Focus on:
                - Code quality and maintainability
                - Security best practices
                - Performance optimization
                - Error handling and logging
                - Documentation and comments
                - Testing considerations

                Provide categorized feedback:
                üî¥ REQUIRED - Critical issues that must be fixed
                üü° IMPORTANT - Significant improvements needed
                üîµ SUGGESTIONS - Optional enhancements

                Focus on actionable feedback that helps improve code quality, security, and maintainability.`
            };

            const reviewPrompt = prompts[repoType] || prompts['general'];
            core.setOutput('review_prompt', reviewPrompt);
            core.setOutput('repo_type', repoType);

            console.log(`üéØ Repository Type: ${repoType}`);
            console.log(`üìù Using ${repoType} specific prompt for Claude AI review`);

      - name: Validate Review Prompt
        id: validate-prompt
        run: |
          PROMPT="${{ steps.prepare-context.outputs.review_prompt }}"

          # Input validation for security
          if [ -z "$PROMPT" ]; then
            echo "‚ùå Error: Review prompt is empty"
            exit 1
          fi

          # Check for potentially malicious content
          if echo "$PROMPT" | grep -qE "(rm\s+-rf|sudo|eval|exec|system|shell_exec)"; then
            echo "‚ùå Error: Review prompt contains potentially dangerous commands"
            exit 1
          fi

          # Limit prompt length for security
          if [ ${#PROMPT} -gt 50000 ]; then
            echo "‚ùå Error: Review prompt exceeds maximum length (50000 characters)"
            exit 1
          fi

          echo "‚úÖ Review prompt validation passed"

      - name: Claude AI Review (Attempt 1)
        id: claude-review-1
        continue-on-error: true
        uses: anthropics/claude-code-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          direct_prompt: ${{ steps.prepare-context.outputs.review_prompt }}

      - name: Claude AI Review (Attempt 2 - Retry)
        id: claude-review-2
        if: steps.claude-review-1.outcome == 'failure'
        continue-on-error: true
        uses: anthropics/claude-code-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          direct_prompt: ${{ steps.prepare-context.outputs.review_prompt }}

      - name: Claude AI Review (Attempt 3 - Final Retry)
        id: claude-review-3
        if: steps.claude-review-1.outcome == 'failure' && steps.claude-review-2.outcome == 'failure'
        continue-on-error: true
        uses: anthropics/claude-code-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          direct_prompt: ${{ steps.prepare-context.outputs.review_prompt }}

      - name: Determine Successful Review
        id: review-success
        run: |
          if [ "${{ steps.claude-review-1.outcome }}" = "success" ]; then
            echo "successful_attempt=1" >> $GITHUB_OUTPUT
            echo "review_response=${{ steps.claude-review-1.outputs.response }}" >> $GITHUB_OUTPUT
            echo "‚úÖ Claude AI Review succeeded on attempt 1"
          elif [ "${{ steps.claude-review-2.outcome }}" = "success" ]; then
            echo "successful_attempt=2" >> $GITHUB_OUTPUT
            echo "review_response=${{ steps.claude-review-2.outputs.response }}" >> $GITHUB_OUTPUT
            echo "‚úÖ Claude AI Review succeeded on attempt 2"
          elif [ "${{ steps.claude-review-3.outcome }}" = "success" ]; then
            echo "successful_attempt=3" >> $GITHUB_OUTPUT
            echo "review_response=${{ steps.claude-review-3.outputs.response }}" >> $GITHUB_OUTPUT
            echo "‚úÖ Claude AI Review succeeded on attempt 3"
          else
            echo "successful_attempt=none" >> $GITHUB_OUTPUT
            echo "review_response=" >> $GITHUB_OUTPUT
            echo "‚ùå All Claude AI Review attempts failed"
            exit 1
          fi

      - name: Parse Claude Review and Update Tracking
        id: parse-review
        run: |
          echo "üîç Processing Claude review with enhanced tracking..."

          # Set environment variables for the script
          export PR_NUMBER="${{ github.event.pull_request.number }}"
          export CLAUDE_OUTPUT="${{ steps.review-success.outputs.review_response || '' }}"
          export REPO_TYPE="${{ steps.prepare-context.outputs.repo_type }}"

          # Run the enhanced Claude review processor
          if node .github/scripts/claude-review-enhancer.js >> $GITHUB_OUTPUT; then
            echo "‚úÖ Claude review processing completed successfully"
          else
            echo "‚ùå Claude review processing failed, using fallback"
            # Fallback to basic parsing
            echo "has_blocking_issues=false" >> $GITHUB_OUTPUT
            echo "required_count=0" >> $GITHUB_OUTPUT
            echo "important_count=0" >> $GITHUB_OUTPUT
          fi

      - name: Post Enhanced Claude Review Comment
        if: steps.review-success.outputs.successful_attempt != 'none'
        uses: actions/github-script@v7
        with:
          script: |
            const enhancedComment = `${{ steps.parse-review.outputs.enhanced_comment || steps.review-success.outputs.review_response }}`;

            // Post the enhanced review comment
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: enhancedComment
            });

            console.log('üìù Posted enhanced Claude AI review comment');

      - name: Handle Claude AI Review Failure
        if: steps.review-success.outputs.successful_attempt == 'none'
        uses: actions/github-script@v7
        with:
          script: |
            const failureComment = `## ‚ö†Ô∏è Claude AI Review Service Unavailable

            The Claude AI Review Bot encountered technical difficulties and was unable to complete the review after multiple attempts.

            ### üìã Manual Review Required
            - **Status**: ‚ùå Automated review failed
            - **Action Required**: Manual code review needed
            - **Merge Status**: ‚è≥ Pending manual approval

            ### üîÑ Next Steps
            1. A human reviewer should manually review this PR
            2. Address any obvious code quality issues
            3. Ensure all tests pass
            4. Proceed with manual approval when ready

            *This is a temporary service issue. The Claude AI Review Bot will resume normal operation once the service is restored.*`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: failureComment
            });

            console.log('üìù Posted Claude AI service failure notice');

  auto-approval:
    needs: claude-review
    if: always() && (needs.claude-review.result == 'success' || needs.claude-review.result == 'failure')
    runs-on: ubuntu-latest
    timeout-minutes: 5

    permissions:
      contents: read
      pull-requests: write
      checks: read

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Check Auto-Approval Criteria
        id: check-criteria
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            // Check if tracking file exists
            const trackingFile = path.join('.github/claude-tracking', `pr-${context.payload.pull_request.number}-recommendations.json`);
            let hasBlockingIssues = false;

            if (fs.existsSync(trackingFile)) {
              const trackingData = JSON.parse(fs.readFileSync(trackingFile, 'utf8'));
              const unresolvedRequired = trackingData.total_recommendations.required - trackingData.resolved_recommendations.required.length;
              hasBlockingIssues = unresolvedRequired > 0;

              console.log(`üìã Tracking data: ${unresolvedRequired} unresolved REQUIRED items`);
            } else {
              // Fallback: check if Claude review had blocking issues
              hasBlockingIssues = '${{ needs.claude-review.outputs.has_blocking_issues }}' === 'true';
              console.log(`üìã No tracking file, using Claude output: blocking=${hasBlockingIssues}`);
            }

            // Check if Claude review succeeded
            const claudeReviewSucceeded = '${{ needs.claude-review.result }}' === 'success';

            // Auto-approval decision based ONLY on Claude's recommendations
            // GitHub checks are handled separately by branch protection rules
            const shouldApprove = claudeReviewSucceeded && !hasBlockingIssues;

            core.setOutput('should_approve', shouldApprove ? 'true' : 'false');
            core.setOutput('blocking_issues', hasBlockingIssues ? 'true' : 'false');
            core.setOutput('claude_review_failed', claudeReviewSucceeded ? 'false' : 'true');

            console.log(`üéØ Auto-approval decision: ${shouldApprove ? 'APPROVE' : 'SKIP'}`);
            console.log(`   - Claude review succeeded: ${claudeReviewSucceeded}`);
            console.log(`   - Blocking issues: ${hasBlockingIssues}`);
            console.log(`   - GitHub checks: Handled by branch protection rules`);

      - name: Enhanced Token Security Validation
        if: steps.check-criteria.outputs.should_approve == 'true'
        run: |
          echo "üîí Validating GitHub token permissions and security..."

          # Document required permissions for different token types:
          echo "üìã Required Token Permissions:"
          echo "  BOT_GITHUB_TOKEN (preferred):"
          echo "    - pull_requests: write (approve PRs, create reviews)"
          echo "    - contents: read (access repository content)"
          echo "    - metadata: read (access repository metadata)"
          echo "    - statuses: write (create status checks)"
          echo "    - actions: read (read workflow information)"
          echo ""
          echo "  github.token (fallback):"
          echo "    - pull_requests: write (limited to current repository)"
          echo "    - contents: read (limited to current repository)"
          echo "    - Note: Limited scope, may not work for cross-repository operations"

          # Validate token availability and log security status
          if [ -n "${{ secrets.BOT_GITHUB_TOKEN }}" ]; then
            echo "‚úÖ Using BOT_GITHUB_TOKEN with enhanced cross-repository permissions"
            echo "üîí Security: Dedicated bot token with minimal required scopes"
          else
            echo "‚ö†Ô∏è Using default github.token with repository-limited permissions"
            echo "üîí Security: Default token with automatic scope limitation"
            echo "üí° Recommendation: Configure BOT_GITHUB_TOKEN for enhanced functionality"
          fi

          # Security audit log
          echo "üõ°Ô∏è Security Audit:"
          echo "  - Token scope: $([ -n "${{ secrets.BOT_GITHUB_TOKEN }}" ] && echo "Enhanced (BOT_GITHUB_TOKEN)" || echo "Limited (github.token)")"
          echo "  - Repository access: $([ -n "${{ secrets.BOT_GITHUB_TOKEN }}" ] && echo "Cross-repository capable" || echo "Current repository only")"
          echo "  - Permission model: Principle of least privilege applied"

      - name: Auto-Approve PR
        if: steps.check-criteria.outputs.should_approve == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.BOT_GITHUB_TOKEN || github.token }}
          script: |
            console.log('üéâ Creating approval review - all criteria met');

            await github.rest.pulls.createReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number,
              event: 'APPROVE',
              body: `## ‚úÖ BlazeCommerce Claude AI Review - Auto-Approved

            ü§ñ **Automated approval** - All quality gates passed:
            - ‚úÖ No blocking (üî¥ REQUIRED) issues found
            - ‚úÖ Code meets BlazeCommerce standards for ${{ steps.prepare-context.outputs.repo_type }} development

            *This PR has been automatically approved by the BlazeCommerce Claude AI Review Bot.*`
            });

            console.log('‚úÖ PR approved successfully');

      - name: Post Skip Reason
        if: steps.check-criteria.outputs.should_approve == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const blockingIssues = '${{ steps.check-criteria.outputs.blocking_issues }}' === 'true';
            const claudeReviewFailed = '${{ steps.check-criteria.outputs.claude_review_failed }}' === 'true';

            let skipReason = '## ‚è≥ BlazeCommerce Claude AI Review - Approval Pending\n\n';

            if (claudeReviewFailed) {
              skipReason += '‚ö†Ô∏è **Claude AI Review Failed**: The automated review service encountered technical difficulties. Manual review required.\n\n';
            }

            if (blockingIssues) {
              skipReason += '‚ùå **Blocking Issues Found**: This PR has üî¥ REQUIRED recommendations that must be addressed before approval.\n\n';
            }

            skipReason += 'üìã **Note**: GitHub checks status is handled separately by branch protection rules.\n\n';

            if (!claudeReviewFailed) {
              skipReason += '*Address the Claude AI recommendations above and the bot will automatically approve when criteria are met.*';
            } else {
              skipReason += '*Manual review and approval required due to service issues.*';
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: skipReason
            });

            console.log('üìù Posted skip reason comment');
