name: Test Bot Token

on:
  workflow_dispatch:  # Manual trigger only

jobs:
  test-token:
    runs-on: ubuntu-latest
    steps:
      - name: Test Bot Authentication
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.BOT_GITHUB_TOKEN }}
          script: |
            try {
              // Test 1: Check authenticated user
              const { data: user } = await github.rest.users.getAuthenticated();
              console.log(`‚úÖ Authenticated as: ${user.login}`);
              console.log(`üìß Email: ${user.email || 'Not provided'}`);
              console.log(`üè¢ Type: ${user.type}`);
              
              // Test 2: Check repository access
              const { data: repo } = await github.rest.repos.get({
                owner: context.repo.owner,
                repo: context.repo.repo
              });
              console.log(`‚úÖ Repository access: ${repo.name}`);
              console.log(`üîí Permissions: ${JSON.stringify(repo.permissions)}`);
              
              // Test 3: Check if we can list PRs
              const { data: prs } = await github.rest.pulls.list({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                per_page: 1
              });
              console.log(`‚úÖ Can list PRs: ${prs.length} open PR(s)`);
              
              // Test 4: Check organization membership
              try {
                const { data: membership } = await github.rest.orgs.getMembershipForAuthenticatedUser({
                  org: context.repo.owner
                });
                console.log(`‚úÖ Organization membership: ${membership.role} in ${membership.organization.login}`);
              } catch (orgError) {
                console.log(`‚ö†Ô∏è Organization membership check failed: ${orgError.message}`);
              }
              
              console.log('üéâ All token tests passed!');
              
            } catch (error) {
              console.log(`‚ùå Token test failed: ${error.message}`);
              console.log(`üîç Error details:`, error);
              throw error;
            }
