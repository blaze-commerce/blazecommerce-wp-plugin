name: Auto Version Bump

on:
  push:
    branches: [ main ]
    paths-ignore:
      # Files managed by the version bump process itself
      - 'CHANGELOG.md'
      - 'package.json'
      - 'package-lock.json'
      - 'blaze-wooless.php'
      - 'blocks/package.json'

      # CI/CD and development tooling (no user impact)
      - '.github/**'
      - 'scripts/**'
      - 'tests/**'
      - 'test/**'
      - 'bin/**'

      # Internal documentation (no user impact)
      - 'docs/**'
      - 'CONTRIBUTING.md'
      - 'TODO'
      - 'IMPLEMENTATION_SUMMARY.md'
      - 'VERSION_BUMP_BEHAVIOR_EXPLANATION.md'
      - 'CHANGELOG_VERSION_FIX.md'

      # Development configuration files
      - 'phpunit.xml'
      - 'jest.config.js'
      - 'github-workflows-tests.yml'
      - 'test.html'

      # Auto-generated files
      - 'composer.lock'
      - 'vendor/**'
      - 'blocks/yarn.lock'
      - 'blocks/package-lock.json'

      # Git and editor files
      - '.gitignore'
      - '.editorconfig'
      - '**/.DS_Store'

      # AI assistant and editor configuration
      - '.augment/**'
      - '.claude/**'
      - '.vscode/**'

jobs:
  version-bump:
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, '[skip ci]') && !contains(github.event.head_commit.message, 'chore(release)') && !contains(github.event.head_commit.message, '[no version]')"
    permissions:
      contents: write
      pull-requests: read

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.AUTOMATION_TOKEN || secrets.BC_GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install dependencies
      run: npm install

    - name: Configure Git
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"

    - name: Run version system tests
      run: |
        echo "üß™ Running version system tests..."

        # Check if test script exists before running
        if npm run test:version-system --silent 2>/dev/null; then
          echo "‚úÖ Version system tests passed"
        elif [ $? -eq 127 ] || ! npm run | grep -q "test:version-system"; then
          echo "‚ö†Ô∏è  test:version-system script not found, running fallback validation..."

          # Fallback: Basic validation of core functions
          node -e "
            try {
              const semver = require('./scripts/semver-utils');
              console.log('‚úÖ semver-utils module loads successfully');

              // Test basic functions exist
              if (typeof semver.incrementVersion !== 'function') throw new Error('incrementVersion function missing');
              if (typeof semver.findNextAvailableVersion !== 'function') throw new Error('findNextAvailableVersion function missing');
              if (typeof semver.tagExists !== 'function') throw new Error('tagExists function missing');

              console.log('‚úÖ Core functions are available');
              console.log('‚úÖ Fallback validation passed');
            } catch (error) {
              console.error('‚ùå Fallback validation failed:', error.message);
              process.exit(1);
            }
          "
        else
          echo "‚ùå Version system tests failed. Aborting version bump."
          echo "   Exit code: $?"
          echo "   Please check test implementation and dependencies"
          exit 1
        fi

    - name: Validate current version system
      run: |
        echo "üîç Validating current version system..."
        # Skip conflict checking since we handle version conflicts in the workflow
        node scripts/validate-version.js --verbose --no-conflicts
        if [ $? -ne 0 ]; then
          echo "‚ùå Version validation failed. Aborting version bump."
          exit 1
        fi

    - name: Determine version bump type
      id: bump_type
      run: |
        echo "üîç Analyzing commits for version bump type..."

        # Get all non-merge commits since last version tag or last 50 commits if no tags
        LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
        if [ -n "$LAST_TAG" ]; then
          echo "üìã Analyzing commits since tag: $LAST_TAG"
          COMMITS=$(git log --oneline --no-merges --format="%s" ${LAST_TAG}..HEAD)
        else
          echo "üìã No previous tags found, analyzing last 50 commits"
          COMMITS=$(git log --oneline --no-merges --format="%s" -50)
        fi

        if [ -z "$COMMITS" ]; then
          echo "‚ÑπÔ∏è  No commits found to analyze"
          echo "BUMP_TYPE=none" >> $GITHUB_OUTPUT
          exit 0
        fi

        echo "üìä Commits to analyze:"
        echo "$COMMITS" | head -10
        if [ $(echo "$COMMITS" | wc -l) -gt 10 ]; then
          echo "... and $(( $(echo "$COMMITS" | wc -l) - 10 )) more"
        fi
        echo ""

        # Enhanced conventional commit detection
        HAS_BREAKING=false
        HAS_FEATURE=false
        HAS_FIX=false
        HAS_PERF=false

        while IFS= read -r commit; do
          # Skip empty lines
          [ -z "$commit" ] && continue

          # Check for breaking changes (multiple patterns)
          if echo "$commit" | grep -qE "^(feat|fix|docs|style|refactor|perf|test|chore|build|ci)(\(.+\))?!:" || \
             echo "$commit" | grep -qE "BREAKING CHANGE" || \
             echo "$commit" | grep -qE "^(feat|fix)!(\(.+\))?:"; then
            HAS_BREAKING=true
            echo "üí• Breaking change detected: $commit"
          # Check for features
          elif echo "$commit" | grep -qE "^feat(\(.+\))?:"; then
            HAS_FEATURE=true
            echo "‚ú® Feature detected: $commit"
          # Check for fixes and performance improvements
          elif echo "$commit" | grep -qE "^(fix|perf)(\(.+\))?:"; then
            if echo "$commit" | grep -qE "^fix(\(.+\))?:"; then
              HAS_FIX=true
              echo "üêõ Fix detected: $commit"
            else
              HAS_PERF=true
              echo "‚ö° Performance improvement detected: $commit"
            fi
          fi
        done <<< "$COMMITS"

        # Determine bump type based on priority
        if [ "$HAS_BREAKING" = true ]; then
          echo "BUMP_TYPE=major" >> $GITHUB_OUTPUT
          echo "üöÄ Result: MAJOR version bump (breaking changes detected)"
        elif [ "$HAS_FEATURE" = true ]; then
          echo "BUMP_TYPE=minor" >> $GITHUB_OUTPUT
          echo "üöÄ Result: MINOR version bump (new features detected)"
        elif [ "$HAS_FIX" = true ] || [ "$HAS_PERF" = true ]; then
          echo "BUMP_TYPE=patch" >> $GITHUB_OUTPUT
          echo "üöÄ Result: PATCH version bump (fixes/improvements detected)"
        else
          echo "BUMP_TYPE=none" >> $GITHUB_OUTPUT
          echo "‚ÑπÔ∏è  Result: No version bump (no conventional commits found)"
        fi

    - name: Preview version bump
      if: steps.bump_type.outputs.BUMP_TYPE != 'none'
      run: |
        CURRENT_VERSION=$(node -p "require('./package.json').version")
        echo "üì¶ Current version: $CURRENT_VERSION"
        echo "üîÑ Bump type: ${{ steps.bump_type.outputs.BUMP_TYPE }}"

        # Calculate new version
        case "${{ steps.bump_type.outputs.BUMP_TYPE }}" in
          "major")
            NEW_VERSION=$(node -e "
              const semver = require('./scripts/semver-utils');
              console.log(semver.incrementVersion('$CURRENT_VERSION', 'major'));
            ")
            ;;
          "minor")
            NEW_VERSION=$(node -e "
              const semver = require('./scripts/semver-utils');
              console.log(semver.incrementVersion('$CURRENT_VERSION', 'minor'));
            ")
            ;;
          "patch")
            NEW_VERSION=$(node -e "
              const semver = require('./scripts/semver-utils');
              console.log(semver.incrementVersion('$CURRENT_VERSION', 'patch'));
            ")
            ;;
        esac

        # Validate that NEW_VERSION was calculated
        if [ -z "$NEW_VERSION" ]; then
          echo "‚ùå Error: NEW_VERSION was not calculated properly"
          exit 1
        fi

        # Handle edge case: Version conflict resolution
        # This occurs when conventional commits would result in the same version as current
        # (e.g., when no conventional commits are found but BUMP_TYPE was determined)
        # Solution: Force a patch increment to ensure version progression
        if [ "$NEW_VERSION" = "$CURRENT_VERSION" ]; then
          echo "‚ö†Ô∏è  Version conflict detected:"
          echo "   Current version: $CURRENT_VERSION"
          echo "   Calculated version: $NEW_VERSION"
          echo "üîÑ Auto-resolving by forcing patch version increment..."

          # Force patch increment using validated semver utilities
          FORCED_VERSION=$(node -e "
            try {
              const semver = require('./scripts/semver-utils');
              const newVersion = semver.incrementVersion('$CURRENT_VERSION', 'patch');
              console.log(newVersion);
            } catch (error) {
              console.error('Error incrementing version:', error.message);
              process.exit(1);
            }
          ")

          # Validate the forced version was generated successfully
          if [ $? -eq 0 ] && [ -n "$FORCED_VERSION" ]; then
            NEW_VERSION="$FORCED_VERSION"
            echo "‚úÖ Version conflict resolved:"
            echo "   New version: $NEW_VERSION"
            echo "   Bump type: PATCH (auto-forced)"
            echo "BUMP_TYPE=patch" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Error: Failed to generate forced patch version"
            exit 1
          fi
        fi

        # Enhanced auto-increment logic: Check for git tag conflicts and auto-resolve
        echo "üîç Checking for git tag conflicts..."
        echo "üìä Conflict Resolution Details:"
        echo "   Repository: $(git remote get-url origin 2>/dev/null || echo 'local')"
        echo "   Current branch: $(git branch --show-current)"
        echo "   Total existing tags: $(git tag | wc -l)"

        ORIGINAL_NEW_VERSION="$NEW_VERSION"

        # Function to validate version format
        validate_version_format() {
          local version="$1"
          if [[ ! "$version" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.-]+)?(\+[a-zA-Z0-9.-]+)?$ ]]; then
            echo "‚ùå Invalid version format: $version"
            echo "   Expected format: X.Y.Z or X.Y.Z-prerelease+build"
            return 1
          fi
          return 0
        }

        # Validate calculated version format
        if ! validate_version_format "$NEW_VERSION"; then
          echo "‚ùå Error: Calculated version has invalid format"
          echo "   Version: $NEW_VERSION"
          echo "   Please check conventional commit analysis logic"
          exit 1
        fi

        # Check if the calculated version's git tag already exists
        TAG_NAME="v$NEW_VERSION"
        echo "üè∑Ô∏è  Checking tag: $TAG_NAME"

        if git rev-parse --verify "$TAG_NAME" >/dev/null 2>&1; then
          echo "‚ö†Ô∏è  Git tag conflict detected:"
          echo "   Calculated version: $NEW_VERSION"
          echo "   Git tag $TAG_NAME already exists"
          echo "   Tag creation date: $(git log -1 --format=%ci "$TAG_NAME" 2>/dev/null || echo 'unknown')"
          echo "üîÑ Auto-resolving by finding next available version..."

          # Enhanced error handling for findNextAvailableVersion
          RESOLVED_VERSION=$(node -e "
            try {
              const semver = require('./scripts/semver-utils');
              console.error('üîç Starting conflict resolution process...');
              console.error('   Base version: $NEW_VERSION');
              console.error('   Strategy: patch increment');

              const nextVersion = semver.findNextAvailableVersion('$NEW_VERSION', 'patch', {
                verbose: true,
                maxAttempts: 50
              });

              if (!nextVersion) {
                console.error('‚ùå No available version found within reasonable range');
                process.exit(1);
              }

              console.error('‚úÖ Resolution successful: ' + nextVersion);
              console.log(nextVersion);
            } catch (error) {
              console.error('‚ùå Error in findNextAvailableVersion:');
              console.error('   Message: ' + error.message);
              console.error('   Stack: ' + (error.stack || 'No stack trace'));
              console.error('   Possible causes:');
              console.error('   - Git repository access issues');
              console.error('   - Network connectivity problems');
              console.error('   - Corrupted git tags');
              console.error('   - Insufficient permissions');
              process.exit(1);
            }
          ")

          # Enhanced validation of resolved version
          RESOLUTION_EXIT_CODE=$?
          if [ $RESOLUTION_EXIT_CODE -ne 0 ]; then
            echo "‚ùå Error: Version conflict resolution failed (exit code: $RESOLUTION_EXIT_CODE)"
            echo "   Original version: $NEW_VERSION"
            echo "   Troubleshooting steps:"
            echo "   1. Check git repository integrity: git fsck"
            echo "   2. Verify tag permissions: git tag --list | head -5"
            echo "   3. Check network connectivity if using remote repository"
            echo "   4. Review semver-utils.js for potential issues"
            exit 1
          fi

          if [ -z "$RESOLVED_VERSION" ]; then
            echo "‚ùå Error: Empty resolved version returned"
            echo "   This indicates a logic error in findNextAvailableVersion"
            echo "   Please check the semver-utils.js implementation"
            exit 1
          fi

          # Validate resolved version format
          if ! validate_version_format "$RESOLVED_VERSION"; then
            echo "‚ùå Error: Resolved version has invalid format"
            echo "   Resolved version: $RESOLVED_VERSION"
            echo "   This indicates a bug in findNextAvailableVersion"
            exit 1
          fi

          # Final verification that resolved version is actually available
          RESOLVED_TAG_NAME="v$RESOLVED_VERSION"
          if git rev-parse --verify "$RESOLVED_TAG_NAME" >/dev/null 2>&1; then
            echo "‚ùå Error: Resolved version tag already exists"
            echo "   Resolved version: $RESOLVED_VERSION"
            echo "   Tag: $RESOLVED_TAG_NAME"
            echo "   This indicates a race condition or logic error"
            exit 1
          fi

          echo "‚úÖ Git tag conflict resolved successfully:"
          echo "   Original calculated version: $ORIGINAL_NEW_VERSION"
          echo "   Final resolved version: $RESOLVED_VERSION"
          echo "   Resolution method: Auto-incremented patch version"
          echo "   Attempts made: $(node -e "console.log(require('semver').diff('$NEW_VERSION', '$RESOLVED_VERSION') === 'patch' ? require('semver').patch('$RESOLVED_VERSION') - require('semver').patch('$NEW_VERSION') : 'unknown')" 2>/dev/null || echo 'calculated')"
          echo "   Verified tag availability: ‚úÖ"

          NEW_VERSION="$RESOLVED_VERSION"

          # Update bump type to patch since we're doing patch increments for resolution
          echo "BUMP_TYPE=patch" >> $GITHUB_OUTPUT
        else
          echo "‚úÖ No git tag conflicts detected for $TAG_NAME"
          echo "   Tag is available for use"
        fi

        echo "üì¶ Final version will be: $NEW_VERSION"
        echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_ENV

    - name: Bump version
      if: steps.bump_type.outputs.BUMP_TYPE != 'none'
      run: |
        echo "üîÑ Bumping version using npm scripts..."
        npm run version:${{ steps.bump_type.outputs.BUMP_TYPE }}

        echo "‚úÖ Version bump completed"
        UPDATED_VERSION=$(node -p "require('./package.json').version")
        echo "üì¶ Updated version: $UPDATED_VERSION"

    - name: Update changelog
      if: steps.bump_type.outputs.BUMP_TYPE != 'none'
      run: |
        echo "üìù Updating changelog..."
        npm run changelog
        echo "‚úÖ Changelog updated"

    - name: Validate post-bump version system
      if: steps.bump_type.outputs.BUMP_TYPE != 'none'
      run: |
        echo "üîç Validating version system after bump..."
        FINAL_VERSION=$(node -p "require('./package.json').version")
        echo "üì¶ Validating final version: $FINAL_VERSION"

        # Use --no-conflicts flag since we've already resolved conflicts in the bump process
        node scripts/validate-version.js --verbose --no-conflicts
        if [ $? -ne 0 ]; then
          echo "‚ùå Post-bump validation failed. This indicates an issue with the version update process."
          echo "   Final version: $FINAL_VERSION"
          echo "   This suggests a problem with file consistency or version format."
          exit 1
        fi

        # Additional verification: Ensure git tag was created successfully
        TAG_NAME="v$FINAL_VERSION"
        if git rev-parse --verify "$TAG_NAME" >/dev/null 2>&1; then
          echo "‚úÖ Git tag $TAG_NAME exists and is valid"
        else
          echo "‚ö†Ô∏è  Git tag $TAG_NAME was not found (this is expected - tag will be created during commit)"
        fi

        echo "‚úÖ Post-bump validation passed successfully"
        echo "üì¶ All version files are consistent at version: $FINAL_VERSION"

    - name: Commit version bump
      if: steps.bump_type.outputs.BUMP_TYPE != 'none'
      run: |
        VERSION=$(node -p "require('./package.json').version")
        echo "üìù Committing version bump to $VERSION..."

        git add .
        git commit -m "chore(release): bump version to $VERSION [skip ci]

        ü§ñ Automated version bump
        üì¶ Version: $VERSION
        üîÑ Bump type: ${{ steps.bump_type.outputs.BUMP_TYPE }}
        üìù Updated files: package.json, blaze-wooless.php, blocks/package.json, CHANGELOG.md"

        echo "üöÄ Pushing changes..."
        git push

        echo "‚úÖ Version bump completed and pushed successfully!"
