name: "Claude Direct Approval"

on:
  pull_request:
    types: [opened, synchronize, reopened]
  pull_request_review:
    types: [submitted, dismissed]

# Simplified concurrency management
concurrency:
  group: claude-direct-approval-pr-${{ github.event.pull_request.number || github.run_id }}
  cancel-in-progress: true

jobs:
  claude-direct-approval:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: github.event_name == 'pull_request' || (github.event_name == 'pull_request_review' && github.event.review.user.login != 'blazecommerce-claude-ai')
    
    outputs:
      approval_status: ${{ steps.approval.outputs.status }}
      pr_number: ${{ steps.pr-info.outputs.pr_number }}
    
    permissions:
      contents: read
      pull-requests: write
    
    steps:
      - name: Get PR information
        id: pr-info
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "Processing PR #$PR_NUMBER"

      - name: Direct approval check
        id: approval
        uses: actions/github-script@v7
        env:
          PR_NUMBER: ${{ steps.pr-info.outputs.pr_number }}
        with:
          script: |
            const prNumber = parseInt(process.env.PR_NUMBER);

            // Simple direct approval logic
            console.log(`Checking direct approval for PR #${prNumber}`);
            
            // For now, just mark as processed
            core.setOutput('status', 'processed');
            console.log('Direct approval check completed');

  summary:
    needs: claude-direct-approval
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Approval Summary
        run: |
          echo "üèÅ Direct Approval Summary"
          echo "========================="
          echo "Job Result: ${{ needs.claude-direct-approval.result }}"
          echo "PR Number: ${{ needs.claude-direct-approval.outputs.pr_number }}"
          echo "Status: ${{ needs.claude-direct-approval.outputs.approval_status }}"
          
          if [ "${{ needs.claude-direct-approval.result }}" = "success" ]; then
            echo "‚úÖ Direct approval check completed"
          else
            echo "‚ùå Direct approval check failed"
          fi
