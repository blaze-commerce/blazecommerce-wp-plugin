name: Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      debug_mode:
        description: 'Enable debug mode for troubleshooting'
        required: false
        default: 'false'
        type: boolean

# Concurrency management to prevent conflicts
concurrency:
  group: tests-${{ github.ref }}
  cancel-in-progress: false

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: ${{ vars.TEST_TIMEOUT || 30 }}

    strategy:
      # Prevent cancellation of other jobs when one fails
      fail-fast: false
      matrix:
        # Enhanced PHP version matrix with better compatibility
        php-version: ['7.4', '8.0', '8.1', '8.2']
        # Updated WordPress versions for better compatibility and security
        wordpress-version: [latest, '6.4', '6.3']
        # Exclude problematic combinations
        exclude:
          - php-version: '8.2'
            wordpress-version: '6.3'
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: wordpress_test
          MYSQL_USER: wp_user
          MYSQL_PASSWORD: wp_password
          MYSQL_ALLOW_EMPTY_PASSWORD: yes
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping --silent"
          --health-interval=10s
          --health-timeout=10s
          --health-retries=5
          --health-start-period=30s
          --default-authentication-plugin=mysql_native_password
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Install system dependencies
      run: |
        echo "üîß SETUP: Installing system dependencies for WordPress testing..."
        echo "üìä Environment: PHP ${{ matrix.php-version }}, WordPress ${{ matrix.wordpress-version }}"
        echo "üêõ Debug Mode: ${{ github.event.inputs.debug_mode || 'false' }}"

        # Update package list with retry mechanism
        echo "üì¶ UPDATING: Package lists..."
        for i in {1..3}; do
          if sudo apt-get update -qq; then
            echo "‚úÖ SUCCESS: Package lists updated"
            break
          fi
          if [ $i -eq 3 ]; then
            echo "‚ùå ERROR: Failed to update package lists after 3 attempts"
            exit 1
          fi
          echo "‚ö†Ô∏è RETRY: Package update failed, attempt $i/3..."
          sleep 5
        done

        # Install all required dependencies with retry mechanism
        echo "üì¶ INSTALLING: Required system dependencies..."
        PACKAGES="subversion mysql-client curl wget unzip tar git bc"

        for i in {1..3}; do
          if sudo apt-get install -y $PACKAGES; then
            echo "‚úÖ SUCCESS: System dependencies installed"
            break
          fi
          if [ $i -eq 3 ]; then
            echo "‚ùå ERROR: Failed to install dependencies after 3 attempts"
            exit 1
          fi
          echo "‚ö†Ô∏è RETRY: Installation failed, attempt $i/3..."
          sleep 5
        done

        # Verify all critical dependencies with enhanced error reporting
        echo "üîç VERIFYING: Checking all required dependencies..."

        # Function to verify command availability
        verify_command() {
          local cmd=$1
          local description=$2
          if ! command -v "$cmd" &> /dev/null; then
            echo "‚ùå ERROR: $description - $cmd command not found"
            echo "üîç DEBUG: Available commands in PATH:"
            echo "$PATH" | tr ':' '\n' | head -5
            return 1
          fi
          local version_info
          case "$cmd" in
            svn) version_info=$(svn --version --quiet 2>/dev/null || echo "version unavailable") ;;
            mysql) version_info=$(mysql --version 2>/dev/null || echo "version unavailable") ;;
            mysqladmin) version_info=$(mysqladmin --version 2>/dev/null || echo "version unavailable") ;;
            curl) version_info=$(curl --version 2>/dev/null | head -1 || echo "version unavailable") ;;
            wget) version_info=$(wget --version 2>/dev/null | head -1 || echo "version unavailable") ;;
            *) version_info=$($cmd --version 2>/dev/null | head -1 || echo "version unavailable") ;;
          esac
          echo "‚úÖ SUCCESS: $description available - $version_info"
          return 0
        }

        # Verify each critical dependency
        verify_command "svn" "SVN (Subversion) - Critical for WordPress test files" || exit 1
        verify_command "mysql" "MySQL client - Critical for database operations" || exit 1
        verify_command "mysqladmin" "MySQL admin tools - Critical for database health checks" || exit 1

        # Verify HTTP clients (at least one must be available)
        if ! command -v curl &> /dev/null && ! command -v wget &> /dev/null; then
          echo "‚ùå ERROR: Neither curl nor wget is available"
          exit 1
        fi
        command -v curl &> /dev/null && verify_command "curl" "HTTP client (curl)"
        command -v wget &> /dev/null && verify_command "wget" "HTTP client (wget)"

        verify_command "unzip" "Archive extraction tool (unzip)" || exit 1
        verify_command "tar" "Archive tool (tar)" || exit 1
        verify_command "git" "Version control (git)" || exit 1
        verify_command "bc" "Calculator tool (bc) - Required for coverage calculations" || exit 1

        echo "üéâ SUCCESS: All system dependencies verified successfully"

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: ${{ matrix.php-version }}
        extensions: dom, curl, libxml, mbstring, zip, pcntl, pdo, sqlite, pdo_sqlite, mysql, mysqli, pdo_mysql, bcmath, soap, intl, gd, exif, iconv, imagick, fileinfo, openssl
        coverage: xdebug
        ini-values: |
          memory_limit=512M
          max_execution_time=300
          upload_max_filesize=64M
          post_max_size=64M
          error_reporting=E_ALL
          display_errors=On
          log_errors=On
        tools: composer:v2, phpunit
    
    - name: Cache Composer packages
      id: composer-cache
      uses: actions/cache@v4
      with:
        path: |
          vendor
          ~/.composer/cache
        key: ${{ runner.os }}-php-${{ matrix.php-version }}-composer-${{ hashFiles('**/composer.lock', '**/composer.json') }}
        restore-keys: |
          ${{ runner.os }}-php-${{ matrix.php-version }}-composer-
          ${{ runner.os }}-php-${{ matrix.php-version }}-
          ${{ runner.os }}-composer-
    
    - name: Install Composer dependencies
      run: |
        echo "üì¶ COMPOSER: Installing Composer dependencies..."
        echo "üêò PHP Version: $(php --version | head -1)"
        echo "üéº Composer Version: $(composer --version)"

        # Validate composer.json exists and is valid
        if [ ! -f "composer.json" ]; then
          echo "‚ùå ERROR: composer.json not found"
          exit 1
        fi

        echo "‚úÖ SUCCESS: composer.json found, validating..."

        # Enhanced composer configuration for security and performance
        echo "üîß CONFIGURING: Composer security and performance settings..."
        composer config --global allow-plugins.dealerdirect/phpcodesniffer-composer-installer true
        composer config --global process-timeout 600
        composer config --global cache-ttl 86400

        # Configure platform requirements based on matrix
        composer config platform.php ${{ matrix.php-version }}

        # Validate composer files
        if ! composer validate --no-check-publish --no-check-all --strict; then
          echo "‚ö†Ô∏è WARNING: Composer validation issues detected"
          composer validate --no-check-publish --no-check-all || true
        fi

        # Handle problematic lock file with enhanced logic
        if [ -f "composer.lock" ]; then
          echo "üîç CHECKING: composer.lock status..."

          # Check if lock file is compatible with current PHP version
          if ! composer check-platform-reqs --lock 2>/dev/null; then
            echo "‚ö†Ô∏è WARNING: composer.lock incompatible with PHP ${{ matrix.php-version }}, regenerating..."
            rm composer.lock
          elif ! composer validate --no-check-publish --no-check-all; then
            echo "‚ö†Ô∏è WARNING: composer.lock is out of sync, regenerating..."
            rm composer.lock
          else
            echo "‚úÖ SUCCESS: composer.lock is valid"
          fi
        fi

        # Install dependencies with comprehensive error handling and retry mechanism
        echo "üì• INSTALLING: Composer dependencies with retry mechanism..."

        for i in {1..3}; do
          echo "üîÑ ATTEMPT: $i/3 - Installing dependencies..."

          if composer install \
            --prefer-dist \
            --no-progress \
            --no-interaction \
            --optimize-autoloader \
            --no-suggest \
            --no-dev=false; then
            echo "‚úÖ SUCCESS: Composer dependencies installed successfully"
            break
          fi

          if [ $i -eq 3 ]; then
            echo "‚ùå ERROR: Failed to install Composer dependencies after 3 attempts"
            echo "üîç DEBUG: Composer diagnose output:"
            composer diagnose || true
            echo "üîç DEBUG: Available memory:"
            php -r "echo 'Memory limit: ' . ini_get('memory_limit') . PHP_EOL;"
            exit 1
          fi

          echo "‚ö†Ô∏è RETRY: Installation failed, attempt $i/3. Cleaning cache..."
          composer clear-cache
          sleep 10
        done

        # Verify installation
        echo "üîç VERIFYING: Composer installation..."
        if [ ! -d "vendor" ] || [ ! -f "vendor/autoload.php" ]; then
          echo "‚ùå ERROR: Vendor directory or autoloader not found"
          exit 1
        fi

        echo "üìä SUMMARY: Installed packages:"
        composer show --installed --no-dev | head -10 || true
        echo "üéâ SUCCESS: Composer dependencies verified successfully"
    
    - name: Setup WordPress test environment
      run: |
        echo "üåê WORDPRESS: Setting up WordPress test environment..."
        echo "üìä WordPress Version: ${{ matrix.wordpress-version }}"
        echo "üêò PHP Version: ${{ matrix.php-version }}"
        echo "üóÑÔ∏è Database: MySQL 8.0"

        # Validate test script exists
        if [ ! -f "bin/install-wp-tests.sh" ]; then
          echo "‚ùå ERROR: WordPress test installation script not found"
          echo "üîç DEBUG: Available files in bin/ directory:"
          ls -la bin/ || echo "bin/ directory not found"
          exit 1
        fi

        # Make script executable
        chmod +x bin/install-wp-tests.sh
        echo "‚úÖ SUCCESS: Test installation script is executable"

        # Enhanced MySQL service readiness check
        echo "üîÑ WAITING: Ensuring MySQL service is ready..."
        MYSQL_READY=false

        for i in {1..60}; do
          # Test multiple connection methods for robustness
          if mysql -h 127.0.0.1 -P 3306 -u root -proot -e "SELECT 1" &> /dev/null; then
            echo "‚úÖ SUCCESS: MySQL service is ready (attempt $i)"
            MYSQL_READY=true
            break
          fi

          # Additional diagnostic on every 10th attempt
          if [ $((i % 10)) -eq 0 ]; then
            echo "üîç DIAGNOSTIC: MySQL connection status (attempt $i/60)..."
            mysqladmin -h 127.0.0.1 -P 3306 -u root -proot ping 2>&1 || true
            mysql -h 127.0.0.1 -P 3306 -u root -proot -e "SHOW DATABASES;" 2>&1 || true
          fi

          if [ $i -eq 60 ]; then
            echo "‚ùå ERROR: MySQL service failed to start within 60 seconds"
            echo "üîç DEBUG: Final MySQL diagnostics..."
            mysqladmin -h 127.0.0.1 -P 3306 -u root -proot ping 2>&1 || true
            netstat -tlnp | grep :3306 || true
            exit 1
          fi

          echo "‚è≥ WAITING: MySQL not ready yet, attempt $i/60..."
          sleep 2
        done

        # Verify database creation capabilities
        echo "üîç TESTING: Database creation capabilities..."
        if ! mysql -h 127.0.0.1 -P 3306 -u root -proot -e "CREATE DATABASE IF NOT EXISTS test_connection_db; DROP DATABASE test_connection_db;" &> /dev/null; then
          echo "‚ùå ERROR: Cannot create/drop test databases"
          exit 1
        fi
        echo "‚úÖ SUCCESS: Database operations verified"

        # Enhanced WordPress test environment installation with fallback mechanisms
        echo "üöÄ EXECUTING: Running WordPress test environment setup..."
        echo "üìã PARAMETERS: DB=wordpress_test, USER=root, HOST=127.0.0.1:3306, WP_VERSION=${{ matrix.wordpress-version }}"

        # Set up environment variables for the installation script
        export WP_TESTS_DIR="/tmp/wordpress-tests-lib"
        export WP_CORE_DIR="/tmp/wordpress/"

        # Create directories if they don't exist
        mkdir -p "$WP_TESTS_DIR" "$WP_CORE_DIR"

        # Run installation with enhanced error handling and fallback mechanisms
        INSTALL_SUCCESS=false

        for attempt in {1..3}; do
          echo "üîÑ ATTEMPT: $attempt/3 - Installing WordPress test environment..."

          # Clear any previous failed installation
          if [ $attempt -gt 1 ]; then
            echo "üßπ CLEANUP: Removing previous failed installation..."
            rm -rf "$WP_TESTS_DIR" "$WP_CORE_DIR"
            mkdir -p "$WP_TESTS_DIR" "$WP_CORE_DIR"
          fi

          # Run installation with timeout and verbose output
          if timeout 300 bash -x bin/install-wp-tests.sh wordpress_test root root 127.0.0.1:3306 ${{ matrix.wordpress-version }}; then
            echo "‚úÖ SUCCESS: WordPress test environment installed (attempt $attempt)"
            INSTALL_SUCCESS=true
            break
          fi

          echo "‚ö†Ô∏è WARNING: Installation attempt $attempt failed"

          # Comprehensive diagnostics on failure
          echo "üîç DIAGNOSTICS: Analyzing installation failure..."

          # Check directory creation
          echo "üìÅ CHECKING: Directory structure..."
          [ -d "$WP_TESTS_DIR" ] && echo "‚úÖ WordPress tests library directory exists" || echo "‚ùå WordPress tests library directory missing"
          [ -d "$WP_CORE_DIR" ] && echo "‚úÖ WordPress core directory exists" || echo "‚ùå WordPress core directory missing"

          # Check critical files
          [ -f "$WP_TESTS_DIR/includes/bootstrap.php" ] && echo "‚úÖ WordPress test bootstrap exists" || echo "‚ùå WordPress test bootstrap missing"
          [ -f "$WP_CORE_DIR/wp-config.php" ] && echo "‚úÖ WordPress config exists" || echo "‚ùå WordPress config missing"

          # Test SVN connectivity with fallback
          echo "üîó CHECKING: SVN connectivity..."
          if timeout 30 svn info https://develop.svn.wordpress.org/trunk/ &> /dev/null; then
            echo "‚úÖ SUCCESS: SVN connectivity verified"
          else
            echo "‚ö†Ô∏è WARNING: SVN connectivity issues detected"
            # Try alternative SVN URLs
            for svn_url in "https://core.svn.wordpress.org/trunk/" "https://wordpress.org/download/"; do
              echo "üîÑ TRYING: Alternative URL $svn_url"
              if timeout 15 curl -s --head "$svn_url" &> /dev/null; then
                echo "‚úÖ SUCCESS: Alternative URL accessible"
                break
              fi
            done
          fi

          # Verify database connectivity
          echo "üóÑÔ∏è CHECKING: Database connectivity..."
          if mysql -h 127.0.0.1 -P 3306 -u root -proot -e "SELECT 1" &> /dev/null; then
            echo "‚úÖ SUCCESS: Database connectivity verified"
            mysql -h 127.0.0.1 -P 3306 -u root -proot -e "SHOW DATABASES;" | grep -E "(wordpress_test|Database)" || true
          else
            echo "‚ùå ERROR: Database connectivity failed"
          fi

          if [ $attempt -eq 3 ]; then
            echo "‚ùå FATAL: WordPress test environment setup failed after 3 attempts"
            echo "üîç FINAL DEBUG: System information..."
            echo "üíæ Disk space:"
            df -h /tmp || true
            echo "üß† Memory usage:"
            free -h || true
            echo "üåê Network connectivity:"
            ping -c 3 8.8.8.8 || true
            exit 1
          fi

          echo "‚è≥ WAITING: 10 seconds before retry..."
          sleep 10
        done

        # Final verification
        echo "üîç VERIFICATION: WordPress test environment..."

        # Verify critical files exist
        REQUIRED_FILES=(
          "$WP_TESTS_DIR/includes/bootstrap.php"
          "$WP_TESTS_DIR/includes/functions.php"
          "$WP_CORE_DIR/wp-config.php"
          "$WP_CORE_DIR/wp-load.php"
        )

        for file in "${REQUIRED_FILES[@]}"; do
          if [ ! -f "$file" ]; then
            echo "‚ùå ERROR: Required file missing: $file"
            exit 1
          fi
          echo "‚úÖ VERIFIED: $file exists"
        done

        echo "üéâ SUCCESS: WordPress test environment setup complete and verified"
      env:
        WP_TESTS_DIR: /tmp/wordpress-tests-lib
        WP_CORE_DIR: /tmp/wordpress/
    
    - name: Install WooCommerce for testing
      run: |
        echo "üõí WOOCOMMERCE: Installing WooCommerce for testing..."

        # Ensure plugins directory exists
        PLUGINS_DIR="/tmp/wordpress/wp-content/plugins"
        mkdir -p "$PLUGINS_DIR"
        cd "$PLUGINS_DIR"

        echo "üìÅ Working directory: $(pwd)"

        # Download WooCommerce with retry mechanism and fallback
        WOOCOMMERCE_INSTALLED=false

        for attempt in {1..3}; do
          echo "üîÑ ATTEMPT: $attempt/3 - Downloading WooCommerce..."

          # Try multiple download methods
          if command -v wget &> /dev/null; then
            echo "üì• Using wget to download WooCommerce..."
            if timeout 120 wget -q --show-progress https://downloads.wordpress.org/plugin/woocommerce.latest-stable.zip; then
              echo "‚úÖ SUCCESS: WooCommerce downloaded via wget"
              WOOCOMMERCE_INSTALLED=true
              break
            fi
          fi

          if command -v curl &> /dev/null && [ "$WOOCOMMERCE_INSTALLED" = false ]; then
            echo "üì• Using curl to download WooCommerce..."
            if timeout 120 curl -L -o woocommerce.latest-stable.zip https://downloads.wordpress.org/plugin/woocommerce.latest-stable.zip; then
              echo "‚úÖ SUCCESS: WooCommerce downloaded via curl"
              WOOCOMMERCE_INSTALLED=true
              break
            fi
          fi

          if [ $attempt -eq 3 ]; then
            echo "‚ùå ERROR: Failed to download WooCommerce after 3 attempts"
            echo "üîç DEBUG: Network connectivity test..."
            ping -c 3 downloads.wordpress.org || true
            exit 1
          fi

          echo "‚ö†Ô∏è RETRY: Download failed, attempt $attempt/3..."
          rm -f woocommerce.latest-stable.zip
          sleep 5
        done

        # Verify download
        if [ ! -f "woocommerce.latest-stable.zip" ]; then
          echo "‚ùå ERROR: WooCommerce zip file not found after download"
          exit 1
        fi

        # Check file size (should be > 1MB)
        FILE_SIZE=$(stat -c%s "woocommerce.latest-stable.zip" 2>/dev/null || echo "0")
        if [ "$FILE_SIZE" -lt 1048576 ]; then
          echo "‚ùå ERROR: Downloaded file is too small ($FILE_SIZE bytes), likely corrupted"
          exit 1
        fi
        echo "‚úÖ SUCCESS: Downloaded file size: $FILE_SIZE bytes"

        # Extract WooCommerce
        echo "üì¶ EXTRACTING: WooCommerce plugin..."
        if ! unzip -q woocommerce.latest-stable.zip; then
          echo "‚ùå ERROR: Failed to extract WooCommerce"
          echo "üîç DEBUG: File information:"
          file woocommerce.latest-stable.zip || true
          exit 1
        fi

        # Verify extraction
        if [ ! -d "woocommerce" ]; then
          echo "‚ùå ERROR: WooCommerce directory not found after extraction"
          echo "üîç DEBUG: Available directories:"
          ls -la || true
          exit 1
        fi

        # Verify main plugin file
        if [ ! -f "woocommerce/woocommerce.php" ]; then
          echo "‚ùå ERROR: WooCommerce main plugin file not found"
          echo "üîç DEBUG: WooCommerce directory contents:"
          ls -la woocommerce/ | head -10 || true
          exit 1
        fi

        # Cleanup
        rm woocommerce.latest-stable.zip

        echo "‚úÖ SUCCESS: WooCommerce installed and verified"
        echo "üìä WooCommerce directory size: $(du -sh woocommerce | cut -f1)"
    
    - name: Run PHPUnit tests
      run: |
        echo "üß™ TESTING: Running PHPUnit tests..."
        echo "üêò PHP Version: ${{ matrix.php-version }}"
        echo "üåê WordPress Version: ${{ matrix.wordpress-version }}"
        echo "üêõ Debug Mode: ${{ github.event.inputs.debug_mode || 'false' }}"

        # Comprehensive test environment validation
        echo "üîç VALIDATING: Test environment setup..."

        # Check PHPUnit configuration
        if [ ! -f "phpunit.xml" ]; then
          echo "‚ùå ERROR: phpunit.xml not found"
          echo "üîç DEBUG: Available files in root directory:"
          ls -la *.xml *.json *.php | head -10 || true
          exit 1
        fi
        echo "‚úÖ SUCCESS: phpunit.xml found"

        # Validate PHPUnit configuration
        if ! php -l phpunit.xml &> /dev/null; then
          echo "‚ö†Ô∏è WARNING: phpunit.xml syntax check failed (this is normal for XML files)"
        fi

        # Check PHPUnit binary and version
        if [ ! -f "vendor/bin/phpunit" ]; then
          echo "‚ùå ERROR: PHPUnit binary not found in vendor/bin/"
          echo "üîç DEBUG: Available files in vendor/bin/:"
          ls -la vendor/bin/ || echo "vendor/bin/ directory not found"
          exit 1
        fi
        echo "‚úÖ SUCCESS: PHPUnit binary found"

        # Get PHPUnit version
        PHPUNIT_VERSION=$(vendor/bin/phpunit --version 2>/dev/null || echo "version unknown")
        echo "üìä PHPUnit Version: $PHPUNIT_VERSION"

        # Verify WordPress test environment with detailed checks
        echo "üåê VERIFYING: WordPress test environment..."

        WP_TEST_FILES=(
          "/tmp/wordpress-tests-lib/includes/bootstrap.php"
          "/tmp/wordpress-tests-lib/includes/functions.php"
          "/tmp/wordpress-tests-lib/includes/testcase.php"
        )

        for file in "${WP_TEST_FILES[@]}"; do
          if [ ! -f "$file" ]; then
            echo "‚ùå ERROR: WordPress test file not found: $file"
            echo "üîç DEBUG: WordPress test lib directory contents:"
            ls -la /tmp/wordpress-tests-lib/includes/ || echo "WordPress test includes directory not found"
            exit 1
          fi
          echo "‚úÖ VERIFIED: $file exists"
        done

        # Verify WordPress core files
        WP_CORE_FILES=(
          "/tmp/wordpress/wp-config.php"
          "/tmp/wordpress/wp-load.php"
          "/tmp/wordpress/wp-settings.php"
        )

        for file in "${WP_CORE_FILES[@]}"; do
          if [ ! -f "$file" ]; then
            echo "‚ùå ERROR: WordPress core file not found: $file"
            echo "üîç DEBUG: WordPress core directory contents:"
            ls -la /tmp/wordpress/ || echo "WordPress core directory not found"
            exit 1
          fi
          echo "‚úÖ VERIFIED: $file exists"
        done

        # Verify test bootstrap
        if [ ! -f "tests/bootstrap.php" ]; then
          echo "‚ùå ERROR: Test bootstrap not found"
          echo "üîç DEBUG: Tests directory contents:"
          ls -la tests/ || echo "Tests directory not found"
          exit 1
        fi
        echo "‚úÖ SUCCESS: Test bootstrap found"

        # Verify database connectivity before tests
        echo "üóÑÔ∏è TESTING: Database connectivity..."
        if ! mysql -h 127.0.0.1 -P 3306 -u root -proot -e "USE wordpress_test; SELECT 1;" &> /dev/null; then
          echo "‚ùå ERROR: Cannot access test database"
          echo "üîç DEBUG: Available databases:"
          mysql -h 127.0.0.1 -P 3306 -u root -proot -e "SHOW DATABASES;" || true
          exit 1
        fi
        echo "‚úÖ SUCCESS: Test database accessible"

        # Set up test environment variables
        export WP_TESTS_DIR="/tmp/wordpress-tests-lib"
        export WP_CORE_DIR="/tmp/wordpress/"
        export WP_TESTS_DOMAIN="example.org"
        export WP_TESTS_EMAIL="admin@example.org"
        export WP_TESTS_TITLE="Test Blog"

        # Run tests with comprehensive error handling and retry mechanism
        echo "üöÄ EXECUTING: PHPUnit tests with enhanced error handling..."

        # Prepare test execution
        TEST_SUCCESS=false
        TEST_OUTPUT_FILE="/tmp/phpunit-output.log"

        # Create coverage directory
        mkdir -p tests/coverage

        for attempt in {1..2}; do
          echo "üîÑ ATTEMPT: $attempt/2 - Running PHPUnit tests..."

          # Build PHPUnit command with appropriate options
          PHPUNIT_CMD="vendor/bin/phpunit"
          PHPUNIT_ARGS=(
            "--configuration" "phpunit.xml"
            "--coverage-clover=coverage.xml"
            "--coverage-html=tests/coverage/html"
            "--verbose"
            "--stop-on-failure"
          )

          # Add debug options if debug mode is enabled
          if [ "${{ github.event.inputs.debug_mode || 'false' }}" = "true" ]; then
            PHPUNIT_ARGS+=("--debug")
          fi

          # Execute tests with timeout
          echo "‚è±Ô∏è EXECUTING: $PHPUNIT_CMD ${PHPUNIT_ARGS[*]}"

          if timeout 600 $PHPUNIT_CMD "${PHPUNIT_ARGS[@]}" 2>&1 | tee "$TEST_OUTPUT_FILE"; then
            echo "‚úÖ SUCCESS: PHPUnit tests completed successfully (attempt $attempt)"
            TEST_SUCCESS=true
            break
          fi

          echo "‚ö†Ô∏è WARNING: PHPUnit tests failed on attempt $attempt"

          # Analyze test failure
          echo "üîç ANALYZING: Test failure details..."

          # Check for common issues
          if grep -q "Fatal error" "$TEST_OUTPUT_FILE"; then
            echo "üí• FATAL ERROR detected in test output"
            grep "Fatal error" "$TEST_OUTPUT_FILE" || true
          fi

          if grep -q "Class.*not found" "$TEST_OUTPUT_FILE"; then
            echo "üîç CLASS NOT FOUND error detected"
            grep "Class.*not found" "$TEST_OUTPUT_FILE" || true
          fi

          if grep -q "Database connection" "$TEST_OUTPUT_FILE"; then
            echo "üóÑÔ∏è DATABASE CONNECTION issue detected"
            # Test database connectivity again
            mysql -h 127.0.0.1 -P 3306 -u root -proot -e "SELECT 1;" || true
          fi

          # Show test environment status
          echo "üîç DEBUG: Test environment status..."
          echo "üíæ Disk space:"
          df -h /tmp || true
          echo "üß† Memory usage:"
          free -h || true
          echo "üêò PHP memory limit:"
          php -r "echo 'Memory limit: ' . ini_get('memory_limit') . PHP_EOL;"

          if [ $attempt -eq 2 ]; then
            echo "‚ùå FATAL: PHPUnit tests failed after 2 attempts"
            echo "üìã FINAL DEBUG: Complete test output:"
            cat "$TEST_OUTPUT_FILE" || true
            exit 1
          fi

          echo "‚è≥ WAITING: 10 seconds before retry..."
          sleep 10
        done

        # Verify test results
        echo "üîç VERIFYING: Test results..."

        # Check if coverage file was generated
        if [ -f "coverage.xml" ]; then
          echo "‚úÖ SUCCESS: Coverage report generated"
          echo "üìä Coverage file size: $(stat -c%s coverage.xml) bytes"
        else
          echo "‚ö†Ô∏è WARNING: Coverage report not generated"
        fi

        # Check if HTML coverage was generated
        if [ -d "tests/coverage/html" ] && [ "$(ls -A tests/coverage/html)" ]; then
          echo "‚úÖ SUCCESS: HTML coverage report generated"
        else
          echo "‚ö†Ô∏è WARNING: HTML coverage report not generated"
        fi

        echo "üéâ SUCCESS: PHPUnit tests completed and verified successfully"
      env:
        WP_TESTS_DIR: /tmp/wordpress-tests-lib
        WP_CORE_DIR: /tmp/wordpress/
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v5
      if: always() && hashFiles('coverage.xml') != ''
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-php${{ matrix.php-version }}-wp${{ matrix.wordpress-version }}
        fail_ci_if_error: false
        verbose: true
        token: ${{ secrets.CODECOV_TOKEN }}

    - name: Archive test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-php${{ matrix.php-version }}-wp${{ matrix.wordpress-version }}
        path: |
          tests/coverage/
          coverage.xml
          phpunit.xml
          /tmp/phpunit-output.log
        retention-days: 7

    - name: Archive test logs on failure
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: test-logs-php${{ matrix.php-version }}-wp${{ matrix.wordpress-version }}
        path: |
          /tmp/phpunit-output.log
          /tmp/wordpress-tests-lib/wp-tests-config.php
          /tmp/wordpress/wp-config.php
        retention-days: 14
    
  code-quality:
    runs-on: ubuntu-latest
    timeout-minutes: ${{ vars.CODE_QUALITY_TIMEOUT || 15 }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: 8.1
        extensions: dom, curl, libxml, mbstring, zip, pcntl, pdo, sqlite, pdo_sqlite, mysql, mysqli, pdo_mysql, bcmath, soap, intl, gd, exif, iconv, imagick, fileinfo, openssl
        ini-values: |
          memory_limit=512M
          max_execution_time=300
        tools: composer:v2, phpcs, phpstan

    - name: Cache Composer packages
      uses: actions/cache@v4
      with:
        path: |
          vendor
          ~/.composer/cache
        key: ${{ runner.os }}-php-8.1-composer-quality-${{ hashFiles('**/composer.lock', '**/composer.json') }}
        restore-keys: |
          ${{ runner.os }}-php-8.1-composer-quality-
          ${{ runner.os }}-php-8.1-composer-

    - name: Install Composer dependencies
      run: |
        echo "üîß COMPOSER: Installing Composer dependencies for code quality checks..."

        # Enhanced composer configuration for security and performance
        composer config --global allow-plugins.dealerdirect/phpcodesniffer-composer-installer true
        composer config --global process-timeout 600
        composer config platform.php 8.1

        # Validate composer files
        if ! composer validate --no-check-publish --no-check-all --strict; then
          echo "‚ö†Ô∏è WARNING: Composer validation issues detected"
          composer validate --no-check-publish --no-check-all || true
        fi

        # Handle problematic lock file
        if [ -f "composer.lock" ]; then
          echo "üîç CHECKING: composer.lock status..."
          if ! composer validate --no-check-publish --no-check-all; then
            echo "‚ö†Ô∏è WARNING: composer.lock is out of sync, regenerating..."
            rm composer.lock
          fi
        fi

        # Install dependencies with retry mechanism
        for i in {1..3}; do
          echo "üîÑ ATTEMPT: $i/3 - Installing dependencies..."
          if composer install --prefer-dist --no-progress --no-interaction --optimize-autoloader; then
            echo "‚úÖ SUCCESS: Composer dependencies installed successfully"
            break
          fi
          if [ $i -eq 3 ]; then
            echo "‚ùå ERROR: Failed to install dependencies after 3 attempts"
            exit 1
          fi
          echo "‚ö†Ô∏è RETRY: Installation failed, cleaning cache..."
          composer clear-cache
          sleep 5
        done
    
    - name: Run PHP_CodeSniffer
      run: |
        echo "üîç PHPCS: Running PHP_CodeSniffer..."

        # Check if PHPCS is available
        if [ ! -f "vendor/bin/phpcs" ]; then
          echo "‚ùå ERROR: PHP_CodeSniffer not found in vendor/bin/"
          echo "üîç DEBUG: Available binaries:"
          ls -la vendor/bin/ || true
          exit 1
        fi

        # Get PHPCS version
        PHPCS_VERSION=$(vendor/bin/phpcs --version 2>/dev/null || echo "version unknown")
        echo "üìä PHPCS Version: $PHPCS_VERSION"

        # Check WordPress coding standards
        echo "üîç CHECKING: Available coding standards..."
        vendor/bin/phpcs -i

        # Run PHPCS with enhanced error handling and reporting
        echo "üöÄ EXECUTING: PHP_CodeSniffer analysis..."

        PHPCS_OUTPUT="/tmp/phpcs-output.txt"
        PHPCS_SUCCESS=false

        # Run PHPCS with multiple report formats
        if vendor/bin/phpcs \
          --standard=WordPress \
          --extensions=php \
          --ignore=vendor/,tests/coverage/,node_modules/ \
          --report=summary \
          --report-file="$PHPCS_OUTPUT" \
          .; then
          echo "‚úÖ SUCCESS: PHP_CodeSniffer completed without violations"
          PHPCS_SUCCESS=true
        else
          echo "‚ö†Ô∏è WARNING: PHP_CodeSniffer found coding standard violations"
          echo "üìã VIOLATIONS SUMMARY:"
          cat "$PHPCS_OUTPUT" || true
        fi

        # Generate detailed report for artifacts
        vendor/bin/phpcs \
          --standard=WordPress \
          --extensions=php \
          --ignore=vendor/,tests/coverage/,node_modules/ \
          --report=full \
          --report-file="/tmp/phpcs-detailed.txt" \
          . || true

        echo "üìä PHPCS analysis completed"
      continue-on-error: true

    - name: Run PHPStan
      run: |
        echo "üîç PHPSTAN: Running PHPStan static analysis..."

        # Check if PHPStan is available
        if [ ! -f "vendor/bin/phpstan" ]; then
          echo "‚ùå ERROR: PHPStan not found in vendor/bin/"
          echo "üîç DEBUG: Available binaries:"
          ls -la vendor/bin/ || true
          exit 1
        fi

        # Get PHPStan version
        PHPSTAN_VERSION=$(vendor/bin/phpstan --version 2>/dev/null || echo "version unknown")
        echo "üìä PHPStan Version: $PHPSTAN_VERSION"

        # Check if app directory exists
        if [ ! -d "app/" ]; then
          echo "‚ùå ERROR: app/ directory not found"
          echo "üîç DEBUG: Available directories:"
          ls -la . | grep "^d" || true
          exit 1
        fi

        # Check for PHPStan configuration
        PHPSTAN_CONFIG=""
        if [ -f "phpstan.neon" ]; then
          PHPSTAN_CONFIG="--configuration=phpstan.neon"
          echo "‚úÖ SUCCESS: Using phpstan.neon configuration"
        elif [ -f "phpstan.neon.dist" ]; then
          PHPSTAN_CONFIG="--configuration=phpstan.neon.dist"
          echo "‚úÖ SUCCESS: Using phpstan.neon.dist configuration"
        else
          echo "‚ö†Ô∏è WARNING: No PHPStan configuration file found, using defaults"
        fi

        # Run PHPStan with enhanced error handling
        echo "üöÄ EXECUTING: PHPStan static analysis..."

        PHPSTAN_OUTPUT="/tmp/phpstan-output.txt"

        if vendor/bin/phpstan analyse \
          --level=5 \
          app/ \
          --no-progress \
          --error-format=table \
          $PHPSTAN_CONFIG \
          2>&1 | tee "$PHPSTAN_OUTPUT"; then
          echo "‚úÖ SUCCESS: PHPStan analysis completed without errors"
        else
          echo "‚ö†Ô∏è WARNING: PHPStan found potential issues"
          echo "üìã ANALYSIS RESULTS:"
          cat "$PHPSTAN_OUTPUT" || true
        fi

        echo "üìä PHPStan analysis completed"
      continue-on-error: true

    - name: Archive code quality reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: code-quality-reports
        path: |
          /tmp/phpcs-output.txt
          /tmp/phpcs-detailed.txt
          /tmp/phpstan-output.txt
        retention-days: 7
    
  test-coverage:
    runs-on: ubuntu-latest
    timeout-minutes: ${{ vars.TEST_COVERAGE_TIMEOUT || 20 }}
    # Run coverage even if some test matrix jobs fail
    needs: test
    if: always()

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: wordpress_test
          MYSQL_USER: wp_user
          MYSQL_PASSWORD: wp_password
          MYSQL_ALLOW_EMPTY_PASSWORD: yes
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping --silent"
          --health-interval=10s
          --health-timeout=10s
          --health-retries=5
          --health-start-period=30s
          --default-authentication-plugin=mysql_native_password

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Install system dependencies
      run: |
        echo "üîß SETUP: Installing system dependencies for test coverage..."

        # Update package list with retry mechanism
        for i in {1..3}; do
          if sudo apt-get update -qq; then
            echo "‚úÖ SUCCESS: Package lists updated"
            break
          fi
          if [ $i -eq 3 ]; then
            echo "‚ùå ERROR: Failed to update package lists after 3 attempts"
            exit 1
          fi
          echo "‚ö†Ô∏è RETRY: Package update failed, attempt $i/3..."
          sleep 5
        done

        # Install all required dependencies with retry
        PACKAGES="subversion mysql-client curl wget unzip tar git bc"

        for i in {1..3}; do
          if sudo apt-get install -y $PACKAGES; then
            echo "‚úÖ SUCCESS: System dependencies installed"
            break
          fi
          if [ $i -eq 3 ]; then
            echo "‚ùå ERROR: Failed to install dependencies after 3 attempts"
            exit 1
          fi
          echo "‚ö†Ô∏è RETRY: Installation failed, attempt $i/3..."
          sleep 5
        done

        # Verify critical dependencies
        echo "üîç VERIFYING: Checking required dependencies..."

        verify_command() {
          local cmd=$1
          local description=$2
          if ! command -v "$cmd" &> /dev/null; then
            echo "‚ùå ERROR: $description - $cmd command not found"
            return 1
          fi
          echo "‚úÖ SUCCESS: $description available"
          return 0
        }

        verify_command "svn" "SVN (Subversion)" || exit 1
        verify_command "mysql" "MySQL client" || exit 1
        verify_command "mysqladmin" "MySQL admin tools" || exit 1
        verify_command "bc" "Calculator tool (bc)" || exit 1

        echo "üéâ SUCCESS: All dependencies verified for test coverage"

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: 8.1
        extensions: dom, curl, libxml, mbstring, zip, pcntl, pdo, sqlite, pdo_sqlite, mysql, mysqli, pdo_mysql, bcmath, soap, intl, gd, exif, iconv, imagick, fileinfo, openssl
        coverage: xdebug
        ini-values: |
          memory_limit=512M
          max_execution_time=300
          xdebug.mode=coverage
        tools: composer:v2, phpunit

    - name: Install Composer dependencies
      run: |
        echo "üì¶ COMPOSER: Installing Composer dependencies for test coverage..."

        # Enhanced composer configuration
        composer config --global allow-plugins.dealerdirect/phpcodesniffer-composer-installer true
        composer config --global process-timeout 600
        composer config platform.php 8.1

        # Validate and handle lock file
        if [ -f "composer.lock" ]; then
          echo "üîç CHECKING: composer.lock status..."
          if ! composer validate --no-check-publish --no-check-all; then
            echo "‚ö†Ô∏è WARNING: composer.lock is out of sync, regenerating..."
            rm composer.lock
          fi
        fi

        # Install dependencies with retry mechanism
        for i in {1..3}; do
          echo "üîÑ ATTEMPT: $i/3 - Installing dependencies..."
          if composer install --prefer-dist --no-progress --no-interaction --optimize-autoloader; then
            echo "‚úÖ SUCCESS: Composer dependencies installed successfully"
            break
          fi
          if [ $i -eq 3 ]; then
            echo "‚ùå ERROR: Failed to install dependencies after 3 attempts"
            exit 1
          fi
          composer clear-cache
          sleep 5
        done
    
    - name: Setup WordPress test environment
      run: |
        echo "üåê WORDPRESS: Setting up WordPress test environment for coverage..."

        # Validate test script exists
        if [ ! -f "bin/install-wp-tests.sh" ]; then
          echo "‚ùå ERROR: WordPress test installation script not found"
          exit 1
        fi

        # Make script executable
        chmod +x bin/install-wp-tests.sh

        # Enhanced MySQL service readiness check
        echo "üîÑ WAITING: Ensuring MySQL service is ready..."
        for i in {1..60}; do
          if mysql -h 127.0.0.1 -P 3306 -u root -proot -e "SELECT 1" &> /dev/null; then
            echo "‚úÖ SUCCESS: MySQL service is ready (attempt $i)"
            break
          fi
          if [ $i -eq 60 ]; then
            echo "‚ùå ERROR: MySQL service failed to start within 60 seconds"
            exit 1
          fi
          echo "‚è≥ WAITING: MySQL not ready yet, attempt $i/60..."
          sleep 2
        done

        # Install WordPress test environment with retry mechanism
        echo "üöÄ EXECUTING: Running WordPress test environment setup..."

        for attempt in {1..2}; do
          echo "üîÑ ATTEMPT: $attempt/2 - Installing WordPress test environment..."

          if timeout 300 bash bin/install-wp-tests.sh wordpress_test root root 127.0.0.1:3306 latest; then
            echo "‚úÖ SUCCESS: WordPress test environment installed (attempt $attempt)"
            break
          fi

          if [ $attempt -eq 2 ]; then
            echo "‚ùå ERROR: WordPress test environment setup failed after 2 attempts"
            exit 1
          fi

          echo "‚ö†Ô∏è WARNING: Installation attempt $attempt failed, retrying..."
          rm -rf /tmp/wordpress-tests-lib /tmp/wordpress
          sleep 10
        done

        echo "üéâ SUCCESS: WordPress test environment setup complete"
      env:
        WP_TESTS_DIR: /tmp/wordpress-tests-lib
        WP_CORE_DIR: /tmp/wordpress/
    
    - name: Generate coverage report
      run: |
        echo "üìä ANALYSIS: Generating comprehensive test coverage report..."

        # Ensure coverage directory exists
        mkdir -p tests/coverage/html

        # Set up environment variables
        export WP_TESTS_DIR="/tmp/wordpress-tests-lib"
        export WP_CORE_DIR="/tmp/wordpress/"

        # Generate coverage report with enhanced error handling
        echo "üöÄ EXECUTING: Running PHPUnit with coverage analysis..."

        COVERAGE_SUCCESS=false

        for attempt in {1..2}; do
          echo "üîÑ ATTEMPT: $attempt/2 - Generating coverage report..."

          if timeout 600 vendor/bin/phpunit \
            --configuration phpunit.xml \
            --coverage-html=tests/coverage/html \
            --coverage-clover=coverage.xml \
            --coverage-text \
            --verbose; then
            echo "‚úÖ SUCCESS: Coverage report generated successfully (attempt $attempt)"
            COVERAGE_SUCCESS=true
            break
          fi

          if [ $attempt -eq 2 ]; then
            echo "‚ùå ERROR: Failed to generate coverage report after 2 attempts"
            exit 1
          fi

          echo "‚ö†Ô∏è WARNING: Coverage generation failed, retrying..."
          sleep 10
        done

        # Verify coverage files were generated
        if [ -f "coverage.xml" ]; then
          echo "‚úÖ SUCCESS: Clover coverage report generated"
        else
          echo "‚ö†Ô∏è WARNING: Clover coverage report not found"
        fi

        if [ -d "tests/coverage/html" ] && [ "$(ls -A tests/coverage/html)" ]; then
          echo "‚úÖ SUCCESS: HTML coverage report generated"
        else
          echo "‚ö†Ô∏è WARNING: HTML coverage report not generated"
        fi

        echo "üéâ SUCCESS: Coverage analysis completed"
      env:
        WP_TESTS_DIR: /tmp/wordpress-tests-lib
        WP_CORE_DIR: /tmp/wordpress/

    - name: Check coverage threshold
      run: |
        echo "üéØ THRESHOLD: Checking coverage threshold..."

        # Set up environment variables
        export WP_TESTS_DIR="/tmp/wordpress-tests-lib"
        export WP_CORE_DIR="/tmp/wordpress/"

        # Generate coverage text output and extract percentage
        COVERAGE_OUTPUT=$(vendor/bin/phpunit --configuration phpunit.xml --coverage-text 2>/dev/null | grep "Lines:" | head -1)

        if [ -z "$COVERAGE_OUTPUT" ]; then
          echo "‚ö†Ô∏è WARNING: Could not extract coverage percentage, skipping threshold check"
          exit 0
        fi

        COVERAGE=$(echo "$COVERAGE_OUTPUT" | grep -o '[0-9]\+\.[0-9]\+%' | head -1 | sed 's/%//')

        if [ -z "$COVERAGE" ]; then
          echo "‚ö†Ô∏è WARNING: Could not parse coverage percentage, skipping threshold check"
          exit 0
        fi

        echo "üìä Current Coverage: $COVERAGE%"

        # Check if coverage meets threshold (80%)
        THRESHOLD=80
        if (( $(echo "$COVERAGE >= $THRESHOLD" | bc -l) )); then
          echo "‚úÖ SUCCESS: Coverage $COVERAGE% meets requirement (>= $THRESHOLD%)"
        else
          echo "‚ö†Ô∏è WARNING: Coverage $COVERAGE% is below required $THRESHOLD%"
          echo "üìã This is a warning only and will not fail the build"
        fi
      env:
        WP_TESTS_DIR: /tmp/wordpress-tests-lib
        WP_CORE_DIR: /tmp/wordpress/
      continue-on-error: true

    - name: Archive coverage reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: coverage-reports
        path: |
          tests/coverage/
          coverage.xml
        retention-days: 14
